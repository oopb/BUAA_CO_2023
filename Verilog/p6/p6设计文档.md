# p6设计文档

<img src="./p6设计文档.assets/p6.png" alt="p6"  />

***

## 一、新增模块

### 1.BE（M级）



### 2.DE（M级）



### 3.MDU（E级）




## 二、控制指令

| $NPCOp_{[2:0]}$ | 000    | 001         | 010         | 011       |
| --------------- | ------ | ----------- | ----------- | --------- |
| 功能            | normal | `beq`/`bne` | `jr`/`jalr` | `jal`/`j` |

| $CMPOp_{[2:0]}$ | 000   | 001   |
| --------------- | ----- | ----- |
| 功能            | `beq` | `bne` |

| $ALUOp_{[3:0]}$ | 0000 | 0001 | 0010 | 0011 | 0100  | 0101  | 0110   |
| --------------- | ---- | ---- | ---- | ---- | ----- | ----- | ------ |
| 功能            | A+B  | A-B  | A\|B | A&B  | `lui` | `slt` | `sltu` |

| $MDUOp_{[3:0]}$ | 0000       | 0001   | 0010    | 0011  | 0100   | 0101   | 0110   | 0111   | 1000   |
| --------------- | ---------- | ------ | ------- | ----- | ------ | ------ | ------ | ------ | ------ |
| 功能            | 非乘除操作 | `mult` | `multu` | `div` | `divu` | `mthi` | `mtlo` | `mfhi` | `mflo` |

| $EXTOp_{[1:0]}$ | 00          | 01          |
| --------------- | ----------- | ----------- |
| 功能            | zero_extend | sign_extend |

| $DMOp_{[2:0]}$ | 001       | 010       | 011       |
| -------------- | --------- | --------- | --------- |
| 功能           | `lw`/`sw` | `lb`/`sb` | `lh`/`sh` |

| $DmWE$ | 1              | 0      |
| ------ | -------------- | ------ |
| 功能   | `sw`/`sb`/`sh` | others |

| 指令                | `add` | `sub` | `and` | `or` | `slt` | `sltu` | `m&d` | `mt**` | `mfhi` | `mflo` | `addi` | `andi` | `ori` | `lui` | `l*` | `s*` | `beq` | `bne` | `jal` | `j`  | `jr` | `jalr` |
| ------------------- | ----- | ----- | ----- | ---- | ----- | ------ | ----- | ------ | ------ | ------ | ------ | ------ | ----- | ----- | ---- | ---- | ----- | ----- | ----- | ---- | ---- | ------ |
| $NPCOp_{[2:0]}$     | 000   | 000   | 000   | 000  | 000   | 000    | 000   | 000    | 000    | 000    | 000    | 000    | 000   | 000   | 000  | 000  | 001   | 001   | 011   | 011  | 010  | 010    |
| $CMPOp_{[2:0]}$     |       |       |       |      |       |        |       |        |        |        |        |        |       |       |      |      | 000   | 001   |       |      |      |        |
| $ALUOp_{[3:0]}$     | 0000  | 0001  | 0011  | 0010 | 0101  | 0110   | x     | x      | x      | x      | 0000   | 0011   | 0010  | 0100  | 0000 | 0000 | x     | x     | x     | x    | x    | x      |
| $MDUOp_{[3:0]}$     |       |       |       |      |       |        | *     | *      | 0111   | 1000   |        |        |       |       |      |      |       |       |       |      |      |        |
| $EXTOp_{[1:0]}$     | x     | x     | x     | x    | x     | x      | x     | x      | x      | x      | 01     | 00     | 00    | 00    | 01   | 01   | x     | x     | x     | x    | x    | x      |
| $DMOp_{[2:0]}$      |       |       |       |      |       |        |       |        |        |        |        |        |       |       | *    | *    |       |       |       |      |      |        |
| $DmWE$              |       |       |       |      |       |        |       |        |        |        |        |        |       |       |      | 1    |       |       |       |      |      |        |
| $GRFA3_{[31:0]}$    | `rd`  | `rd`  | `rd`  | `rd` | `rd`  | `rd`   | `0`   | `0`    | `rd`   | `rd`   | `rt`   | `rt`   | `rt`  | `rt`  | `rt` | `0`  | `0`   | `0`   | `31`  | `0`  | `0`  | `rd`   |
| $GRFWDSel_{[1:0]}$  | 00    | 00    | 00    | 00   | 00    | 00     | x     | x      | 00     | 00     | 00     | 00     | 00    | 00    | 01   | x    | x     | x     | 10    | x    | 00   | 10     |
| $ALUASel$           | 0     | 0     | 0     | 0    | 0     | 0      | x     | x      | x      | x      | 0      | 0      | 0     | 0     | 0    | 0    | x     | x     | x     | x    | x    | x      |
| $ALUBSel$           | 0     | 0     | 0     | 0    | 0     | 0      | 0     | 0      | 0      | 0      | 1      | 1      | 1     | 1     | 1    | 1    | 0     | 0     | x     | x    | x    | x      |
| $ALUOutSel_{[1:0]}$ | 00    | 00    | 00    | 00   | 00    | 00     | x     | x      | 01     | 10     | 00     | 00     | 00    | 00    | 00   | 00   | 00    | 00    | 00    | 00   | 00   | 00     |

| $GRFA3_{[31:0]}$ | $GRFWDSel_{[1:0]}$ | $ALUASel$ | $ALUBSel$    | $ALUOutSel_{[1:0]}$ |
| ---------------- | ------------------ | --------- | ------------ | ------------------- |
| `rd`             | 00：ALUOut         | 0：rs     | 0：rt        | 00：ALUC            |
| `rt`             | 01：DmRD           | 1：shamt  | 1：EXT_imm32 | 01：HI              |
| `31`             | 10：PC+8           |           |              | 10：LO              |
| `0`：非写操作    |                    |           |              |                     |



| 类型      | 指令                   | $D\_T_{use}\_rs$ | $D\_T_{use}\_rt$ | $E\_T_{new}$ | $M\_T_{new}$ | $W\_T_{new}$ |
| --------- | ---------------------- | ---------------- | ---------------- | ------------ | ------------ | ------------ |
| calc_reg  | `add`/`sub`/`and`/`or` | 1                | 1                | 1            | 0            | 0            |
| calc_reg  | `slt`/`sltu`           | 1                | 1                | 1            | 0            | 0            |
| calc_imm  | `ori`/`andi`/`addi`    | 1                | 3                | 1            | 0            | 0            |
| calc_imm  | `lui`                  | 3                | 3                | 1            | 0            | 0            |
| md        | `m&d`                  | 1                | 1                | 0            | 0            | 0            |
| mt        | `mt**`                 | 1                | 3                | 0            | 0            | 0            |
| mf        | `mf**`                 | 3                | 3                | 1            | 0            | 0            |
| load      | `lw`/`lb`/`lh`         | 1                | 3                | 2            | 1            | 0            |
| store     | `sw`/`sb`/`sh`         | 1                | 2                | 0            | 0            | 0            |
| branch    | `beq`/`bne`            | 0                | 0                | 0            | 0            | 0            |
| jump_reg  | `jr`/`jalr`            | 0                | 3                | 0            | 0            | 0            |
| jump_addr | `jal`/`j`              | 3                | 3                | 0            | 0            | 0            |

## 三、思考题

1. 为什么需要有单独的乘除法部件而不是整合进 ALU？为何需要有独立的 HI、LO 寄存器？

   > 乘除法的周期数远大于其他运算，将乘除法部件整合进ALU会导致整体周期数大幅度变多；增加HI和LO寄存器可以使得乘除法指令与其他指令并行，待需要的时候在取出。

2. 真实的流水线 CPU 是如何使用实现乘除法的？请查阅相关资料进行简单说明。

   > 计算机乘法是移位和累加实现的，每位的数字代表需要移动几位；计算机除法的实现是移位和累减，首先对齐除数和被除数，对齐后相减，如果结果大于等于0，则记录商1；如果结果小于0，则记录商0之后右移，结果作为下次运算的被除数，并将商左移，循环这个过程，直到除数移回原位，并记录余数。

3. 请结合自己的实现分析，你是如何处理 Busy 信号带来的周期阻塞的？

   > 若D级为md/mf/mt并且E级为md或Busy，则在D级进行阻塞。

4. 请问采用字节使能信号的方式处理写指令有什么好处？（提示：从清晰性、统一性等角度考虑）

   > 将统一的字使能信号分离为单独的字节使能信号，将使能与选择信号统一起来，并且表现字节使能信号使得其更加清晰、直观。

5. 请思考，我们在按字节读和按字节写时，实际从 DM 获得的数据和向 DM 写入的数据是否是一字节？在什么情况下我们按字节读和按字节写的效率会高于按字读和按字写呢？

   > 获得的数据不是一字节，写入的数据是一字节；当所需读写的数据较为分散时按字节效率高于按字。

6. 为了对抗复杂性你采取了哪些抽象和规范手段？这些手段在译码和处理数据冲突的时候有什么样的特点与帮助？

   > 指令分类，添加指令时可以减少错误；将写寄存器使能和写入的寄存器编号合并，当不是写入操作的时候选择写入到0号寄存器。

7. 在本实验中你遇到了哪些不同指令类型组合产生的冲突？你又是如何解决的？相应的测试样例是什么样的？

   > md+mf指令，开始我的mf指令也会暂停，造成周期数过长，最后重新思考相关暂停策略，发现bug
   >
   > ```assembly
   > ori $t0, $0, 0x1234
   > ori $t1, $0, 0x4321
   > mult $t0, $t1
   > mflo $t2
   > mfhi $t3
   > div $t1, $t0
   > mflo $t2
   > mfhi $t3
   > ```

8. 如果你是手动构造的样例，请说明构造策略，说明你的测试程序如何保证**覆盖**了所有需要测试的情况；如果你是**完全随机**生成的测试样例，请思考完全随机的测试程序有何不足之处；如果你在生成测试样例时采用了**特殊的策略**，比如构造连续数据冒险序列，请你描述一下你使用的策略如何**结合了随机性**达到强测的效果。

   > 使用了他人的自动测评机生成随机样例，完全随机的样例由于`slt`/`sltu`/`lb`等指令的存在，在后期的赋值几乎全为0或1，相应解决措施可以将相关指令的生成概率减小。

## 四、测试方案

* 使用课下所给样例进行测试

* 针对性测试

  ```assembly
  ori $5, $0, 0x1234
  ori $6, $0, 0xffff
  sw $5, 0($0)
  sh $6, 2($0)
  sb $6, 4($0)
  sb $6, 5($0)
  sb $6, 6($0)
  sb $6, 7($0)
  
  ori $6, $0,0xf
  sw $6, 0($0)
  ori $6, $0,0xf0
  sh $6, 2($0)
  ori $6, $0, 0xf00
  sb $6, 4($0)
  ori $6, $0, 0xf000
  sb $6, 5($0)
  ori $6, $0, 56123
  sb $6, 6($0)
  ori $6, $0, 16521
  sb $6, 7($0)
  mult $5, $5
  mfhi $7
  ori $5, $0, 200
  ori $6, $0, 30
  mflo $8
  mult $5, $6
  mfhi $7
  mflo $8
  mult $6, $6
  mfhi $7
  mflo $8
  ori $1, $0, 100
  ori $2, $0, 200
  ori $3, $0, 300
  ori $4, $0, 400
  ori $5, $0, 500
  addu $6, $5, $1
  addu $7, $5, $6
  add $8, $6, $7
  add $9, $8, $5
  addi $10, $9, -100
  addi $11, $10, 200
  sw $12, 0($0)
  and $14, $12, $13
  and $15, $14, $13
  andi $16, $15, 200
  addi $16, $15, 0xffff
  ori $1, $0, 0x000f
  ori $2, $0, 0x00f0
  ori $3, $0, 0x0f00
  ori $4, $0, 0xf000
  addu $5, $5, $4
  sw $6, 0($0)
  sw $5, 0($0)
  ori $5, $0, 0xf000
  sll $6, $5, 4
  sll $7, $6, 4
  sll $8, $7, 4
  ori $5, $0, 0x8000
  ori $6, $0, 5
  ori $5, $0,250
  lui $5, 0x8000
  lui $5, 0x8000
  mult $6, $7
  mflo $15
  mtlo $16
  mflo $15
  bne $17, $16, jump
  addi $5, $6, 500
  sw $5, 1528($0)
  jump:
  sh $6, 1530($0)
  lbu $25, 1530($0)
  sb $25, 0($25)
  lb $6, 0($25)
  addi $8, $9, 215
  ```

* 使用大佬写的自动测评机进行测试
